<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/lodash.min.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
	<script>
	var mockTumas = [
		{"id":"1",
		"nome":"Project analisys",
		"quantidadeMaxAlunos":74,
		"quantidadeAlunosCadastrados":"4",
		"diaHora":
		[{"desc":"This is a nice description about this session.","data":"09:09:36 27-Nov-50495"}]},
		{"id":"2",
		"nome":"Nice examples",
		"quantidadeMaxAlunos":59,
		"quantidadeAlunosCadastrados":"2",
		"diaHora":[{"desc":"This is a nice description about this session.","data":"23:22:56 27-Feb-50496"}]},
		{"id":"3",
		"nome":"Session 1: Introduction to Web",
		"quantidadeMaxAlunos":50,
		"quantidadeAlunosCadastrados":"0",
		"diaHora":[{"desc":"This is a nice description about this session.","data":"23:22:56 02-Jun-50493"}]},
		{"id":"4",
		"nome":"Session 2: Databse integration",
		"quantidadeMaxAlunos":37,
		"quantidadeAlunosCadastrados":"0",
		"diaHora":[{"desc":"This is a nice description about this session.","data":"23:22:56 06-Nov-50509"}]},
		{"id":"5",
		"nome":"Project analisys 2",
		"quantidadeMaxAlunos":74,
		"quantidadeAlunosCadastrados":"4",
		"diaHora":
		[{"desc":"This is a nice description about this session.","data":"09:09:36 27-Nov-50495"}]}
		];

		var mockAlunos = [
			{"id":"1",
			"nome":"Student Imprudent",
			"listaTurmas":["1","2"]},
			{"id":"2",
			"nome":"Student Concludent",
			"listaTurmas":["1"]},
			{"id":"4",
			"nome":"New Student",
			"listaTurmas":["1"]}
		]

		var cadastro = {
			idTurma:null,
			listaAlunos:[],
			adicionarAluno: function(idAluno){//adiciona id de um aluno na lista de alunos pendentes para o cadastro
				this.listaAlunos.push(idAluno);
			},
			removerAluno: function(idAluno){//remove o id de um aluno da lista de alunos pendentes para cadastro
				var index = this.listaAlunos.indexOf(idAluno);
				if ( index > -1) {
  				this.listaAlunos.splice(index, 1);
				}
			}
		}

		//converdte a data exibida dos elementos par um objeto que contem os campos ano,mes,dia,hora,mim,seg respectivamente
		function converteData(data){
			var aux = data.split(" ");
			var horario = aux[0].split(":");
			var dia = aux[1].split("-");
			console.log(dia[2]+" "+dia[1]+" "+dia[0]+" "+horario[0]+" "+horario[1]+" "+horario[2]+" "+0);
			return{ano:dia[2],mes:dia[1],dia:dia[0],hora:horario[0],min:horario[1],seg:horario[2]}
		}

		//verifica se duas turmas possuem coicidencia de horario
		function bateHorario(turmaTentativa, turmaCadastrada) {
			var coincide = false;
			console.log("<Comparando>");
			console.log(turmaTentativa);
			console.log(turmaCadastrada);
			console.log("</Comparando>");
			for(var j = 0; j < turmaCadastrada.diaHora.length; j++){
				var dataTurmaCadastrada = converteData(turmaCadastrada.diaHora[j].data);
				for(var i = 0; i < turmaTentativa.diaHora.length; i++){
					var dataTurmaTentativa = converteData(turmaTentativa.diaHora[i].data);
					if(dataTurmaTentativa.ano == dataTurmaCadastrada.ano){
						if(dataTurmaTentativa.mes == dataTurmaCadastrada.mes){
							if(dataTurmaTentativa.dia == dataTurmaCadastrada.dia){
								if(dataTurmaTentativa.hora == dataTurmaCadastrada.hora){
										coincide = true;
								}
							}
						}
					}
				}
			}
			return coincide;
		}

		//recebe uma lista de alunos e retorna apenas os que não estão matriculados na turma com id passado como paramento
		function filtrarAlunos(alunos,idTurma){
			return _.filter(alunos,function(o){
			 console.log(o);
			 if(o.listaTurmas.indexOf(idTurma) == '-1'){
				 return o;
			 }
		 })
		}

		//verifica se a turma possui capacidade para todos os alunos com cadastro para serem realizados
		function verificaCapacidadeTurma(turma){
			if((Number(turma.quantidadeAlunosCadastrados) + cadastro.listaAlunos.length) <= Number(turma.quantidadeMaxAlunos)){
				return true;
			}else return false;
		}

		$( document ).ready( function(){
			$(".grupoAluno").hide();
			var add= "";
			for(var i=0; i<mockTumas.length;i++){
				add+="<option value='"+ mockTumas[i].id+"'>"+mockTumas[i].nome+"</option>";
			}
			$("#turma").append(add);

			//função que dispara ao clicar no botao para selecionar turma
			$("#btnTurma").click(function(){
				var addAluno= "";
				var b = $("#turma").val();
				$("#nomeTurma").text(_.find(mockTumas,{"id": b}).nome);
				console.log("b");
				console.log(b);
				cadastro.idTurma=b;
				var turmaAtual = _.find(mockTumas,{"id": b});

				//lista de alunos que não estão matriculados na turma selecionada
				var listaAlunosInserir = filtrarAlunos(mockAlunos,b);

				var listaAlunos = document.querySelector("#listaAlunos");
				for(var i=0; i<listaAlunosInserir.length;i++){
					var div = document.createElement("div");
					var input= document.createElement("input");
					var label = document.createElement("label");

					//criando o input
					input.setAttribute("type",'checkbox');
					var dataNumAluno = document.createAttribute('data-numAluno');
					dataNumAluno.value = 'aluno'+(i+1);
					input.setAttributeNode(dataNumAluno);
					var dataVlId = document.createAttribute("data-vlId");
					dataVlId.value =  listaAlunosInserir[i].id;
					input.setAttributeNode(dataVlId);
					var id = document.createAttribute("id");
					id.value =  'aluno'+listaAlunosInserir[i].id;
					input.setAttributeNode(id);

					//função que dispara ao clicar no checkbox
					input.addEventListener("click",(function(idAluno,label){
						return function(){
								//verifica se esta marcado
								if(this.checked){
									var coincide=false;
									var aluno =_.find( mockAlunos,{"id": idAluno});
									console.log("<aluno selecionado>");
									console.log(aluno);
									console.log("</aluno selecionado>");
									//verifica se o aluno marcado coicede horário com a turma selecionada
									for(var j = 0; j < aluno.listaTurmas.length; j++){
											if (bateHorario(turmaAtual,_.find(mockTumas,{ "id": aluno.listaTurmas[j]}))){
													coincide = true;
													break;
											}
									}
									//se o aluno coincide horario com a turma selecionada desabilita o chekbox
									if(coincide){
										alert("O aluno "+aluno.nome+" tem aula nesse horario");
										label.style.textDecoration= "line-through";
										this.checked=false;
										this.removeEventListener("click",arguments.callee);
										this.disabled = true;
									}else{//caso não possua coincidencia de horario adiciona o aluno para cadastro
										cadastro.adicionarAluno(idAluno);
									}
								}else{//ao desmarcar o aluno remove o mesmo do cadastro pendente
									cadastro.removerAluno(idAluno);
								}
						}
					})(listaAlunosInserir[i].id,label));

					//cria o label para cada checkbox
					label.setAttribute("for","aluno"+listaAlunosInserir[i].id);
					label.textContent = listaAlunosInserir[i].nome;

					//emenda os elementos
					div.appendChild(input);
					div.appendChild(label);
					listaAlunos.appendChild(div);
				}
				$(".grupoAluno").show();
				$(".grupoTurma").hide();
			})

			//ao clicar no botão salvar para cadastrar os alunos a função abaixo é executada
			$("#btnAlunos").click(function(){
				var idTurma = $("#turma").val();
				var turma = _.find(mockTumas,{"id": idTurma});
				if(verificaCapacidadeTurma(turma)){
					$("#result").text("");
					$("#result").text(JSON.stringify(cadastro));
				}else{
					alert("Número máximo de alunos atingido");
				}
			})
		})
	</script>
</head>

<style>
	/* Set height of the grid so .sidenav can be 100% (adjust if needed) */
	.row.content { height: 760px}

	/* Set gray background color and 100% height */
	.sidenav {
		background-color: #f1f1f1;
		height: 100%;

	}

	/* Set black background color, white text and some padding */
	footer {
		background-color: #555;
		color: white;
		padding: 15px;
	}

	/* On small screens, set height to 'auto' for sidenav and grid */
	@media screen and (max-width: 767px) {
		.sidenav {
			height: auto;
			padding: 15px;
		}
		.row.content {height: auto;}
	}
</style>
</head>
<body>
	<div class="container-fluid">
		<div class="row content">
			<div class="col-sm-3 sidenav">
				<h4>Trabalho TS - Inclusão de Turmas</h4>
				<ul class="nav nav-pills nav-stacked">
					<li class="active">Home</a></li>
				</ul><br>

			</div>

			<div class="col-sm-9">
				<h1 id="teste"></h1>


				<div class="grupoTurma">
					<h3 class="form-group">
						<label for="turma"> Escolha uma turma</label>
					</h3>
					<div class="form-group">

						<select name="turma" id="turma">
							<option value="">Selecione uma turma</option>

						</select>
					</div>

					<div class="form-group">

						<button id="btnTurma" class="btn btn-success">Selecionar</button>
					</div>
				</div>

				<div class="grupoAluno">
					<div >
						<h1>
							Nome Turma : <span id="nomeTurma"></span>
						</h1>
						<label for="turma"> Marque os alunos</label>
					</div>
					<div id="listaAlunos" class="form-group">
						<!-- <input type="checkbox" id="aluno1"> <label for="aluno1">aluno1</label> -->
					</div>

					<div class="form-group">

						<button id="btnAlunos" class="btn btn-success">Salvar</button>
					</div>


					<h3 id="result">

					</h3>
				</div>

			</div>
		</div>
	</div>

	<footer class="container-fluid">
		<p>trabalho Teste de Software</p>
	</footer>

</body>





</html>
